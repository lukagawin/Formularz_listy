<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weryfikacja listÃ³w przewozowych</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      display: none; /* Ukryj do momentu wpisania hasla */
    }
    .duplikat-komunikat {
      color: red;
      font-weight: bold;
      font-size: 3em;
      margin-bottom: 10px;
    }
    .duplikat-wpis {
      background-color: #ffd6d6;
      border-left: 4px solid red;
      padding-left: 4px;
      font-weight: bold;
    }
    #emoji {
      width: 80px;
      display: none;
      margin-bottom: 20px;
    }
    #odliczanie {
      font-size: 1.5em;
      font-weight: bold;
      margin-top: 10px;
      color: #333;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBzFCdVwo6yqBOKgJpzwsAOmcFvDuH6Wik",
      authDomain: "listy-przewozowe.firebaseapp.com",
      projectId: "listy-przewozowe",
      storageBucket: "listy-przewozowe.firebasestorage.app",
      messagingSenderId: "82668165739",
      appId: "1:82668165739:web:16ea9db3946b3c694def2e",
      measurementId: "G-V0X4XK47V6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function zapiszDane(event) {
      event.preventDefault();

      const tekstInput = document.getElementById("tekst");
      const wpis = tekstInput.value.trim();
      const komunikat = document.getElementById("komunikat");
      const emoji = document.getElementById("emoji");
      const odliczanie = document.getElementById("odliczanie");

      komunikat.textContent = "";
      komunikat.classList.remove("duplikat-komunikat");
      emoji.style.display = "none";
      odliczanie.textContent = "";

      if (wpis.length === 0 || wpis.length > 50) {
        alert("ProszÄ™ wpisaÄ‡ numer listu przewozowego (1â€“50 znakÃ³w).");
        return;
      }

      const snapshot = await getDocs(collection(db, "listy"));
      const istnieje = snapshot.docs.some(doc => doc.data().wpis.toLowerCase() === wpis.toLowerCase());

      if (istnieje) {
        komunikat.textContent = "DUPLIKAT!";
        komunikat.classList.add("duplikat-komunikat");
        emoji.style.display = "inline-block";
      } else {
        await addDoc(collection(db, "listy"), {
          wpis: wpis,
          czas: new Date().toLocaleString("pl-PL")
        });
      }

      odliczanie.textContent = "OdÅ›wieÅ¼anie...";
      setTimeout(() => odliczanie.textContent = "", 500);
      tekstInput.value = "";
    }

    function nasluchujListe() {
      const wynik = document.getElementById("wynik");
      const q = query(collection(db, "listy"), orderBy("czas"));

      onSnapshot(q, (snapshot) => {
        wynik.innerHTML = "";
        snapshot.docs.slice().reverse().forEach(doc => {
          const el = doc.data();
          const p = document.createElement("p");
          p.textContent = `Wpis: ${el.wpis}, Czas: ${el.czas}`;
          wynik.appendChild(p);
        });
      });
    }

    async function wyczyscStareDane() {
      const kod = prompt("Podaj kod zabezpieczenia");
      if (kod !== "1231") {
        alert("BÅ‚Ä™dny kod.");
        return;
      }

      const q = query(collection(db, "listy"), orderBy("czas"));
      const snapshot = await getDocs(q);

      if (snapshot.size <= 1000) {
        alert("Pozycji mniej niÅ¼ 1000.");
        return;
      }

      const nadmiarowe = snapshot.docs.slice(0, snapshot.size - 1000);

      // Eksportuj do CSV przed usuniÄ™ciem
      let csv = "Wpis,Czas\n";
      nadmiarowe.forEach(doc => {
        const data = doc.data();
        csv += `${data.wpis},${data.czas}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "usuniete_wpisy.csv");
      link.click();

      for (const d of nadmiarowe) {
        await deleteDoc(doc(db, "listy", d.id));
      }
      alert("UsuniÄ™to stare dane, zostawiono 1000 najnowszych wpisÃ³w.");
    }

    window.zapiszDane = zapiszDane;
    window.wyczyscStareDane = wyczyscStareDane;
    window.onload = () => {
      const haslo = prompt("Podaj hasÅ‚o dostÄ™pu:");
      if (haslo === "MagazynARD") {
        document.body.style.display = "block";
        nasluchujListe();
      } else {
        document.write("<h2>Brak dostÄ™pu</h2>");
      }
    }
  </script>
</head>
<body>
  <h1>Weryfikacja listÃ³w przewozowych</h1>
  <form onsubmit="zapiszDane(event)">
    <label for="tekst">Numer listu przewozowego (max 50 znakÃ³w):</label>
    <input type="text" id="tekst" maxlength="50" required />
    <button type="submit">Zapisz</button>
  </form>
  <div id="komunikat"></div>
  <img id="emoji" src="https://em-content.zobj.net/thumbs/240/apple/354/anguished-face_1f627.png" alt="Zaniepokojona buÅºka" />
  <div id="odliczanie"></div>
  <br/>
  <button onclick="wyczyscStareDane()">ðŸ§¹ WyczyÅ›Ä‡ bazÄ™ (zostaw 1000 najnowszych + eksport)</button>
  <div id="wynik"></div>
</body>
</html>
